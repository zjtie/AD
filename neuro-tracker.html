<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ç»ä¿®å¤ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --nsdr-bg: #f8f9fa;
            --first-aid-bg: #fff3e0;
        }
        body {
            font-family: system-ui;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #ddd;
        }
        .tab-btn.active {
            background: var(--accent);
            color: white;
        }
        .nsdr-section {
            background: var(--nsdr-bg);
            padding: 20px;
            border-radius: 10px;
        }
        .first-aid-section {
            background: var(--first-aid-bg);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .emergency-card {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .usage-counter {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="tab-container">
        <button class="tab-btn active" data-tab="nsdr">æ·±åº¦ä¼‘æ¯è®°å½•</button>
        <button class="tab-btn" data-tab="firstAid">æˆ’æ–­æ€¥æ•‘ç³»ç»Ÿ</button>
    </div>

    <!-- NSDR è®°å½•éƒ¨åˆ† -->
    <div class="nsdr-section" id="nsdrSection">
        <h2>éç¡çœ æ·±åº¦ä¼‘æ¯è®°å½•</h2>
        <div class="grid">
            <div>
                <label>æ—¥æœŸ</label>
                <input type="date" id="date" required>
            </div>
            <div>
                <label>æ”¾æ¾æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="duration" min="0" required>
            </div>
            <div>
                <label>åˆ†å¿ƒæ¬¡æ•°</label>
                <input type="number" id="distractions" min="0" required>
            </div>
        </div>
        
        <div>
            <label>å¿µå¤´æ¸…å•ï¼ˆä¾‹ï¼šå·¥ä½œ/äººé™…å…³ç³»/è‡ªæˆ‘è¯„åˆ¤ï¼‰</label>
            <textarea id="thoughts"></textarea>
        </div>

        <div class="grid">
            <div>
                <label>æ„‰æ‚¦ç¨‹åº¦ (1-10)</label>
                <input type="range" id="pleasure" min="1" max="10" value="5">
            </div>
            <div>
                <label>æ»¡è¶³æ„Ÿ (1-10)</label>
                <input type="range" id="satisfaction" min="1" max="10" value="5">
            </div>
            <div>
                <label>å¿ƒç‡å€¼ (bpm)</label>
                <input type="number" id="heartRate" min="30" max="200">
            </div>
        </div>

        <button onclick="saveNSDR()">ä¿å­˜è®°å½•</button>
        <button onclick="exportCSV()">å¯¼å‡ºè¡¨æ ¼</button>

        <h3>å†å²è®°å½•</h3>
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ—¶é•¿</th>
                    <th>åˆ†å¿ƒæ¬¡æ•°</th>
                    <th>å¿µå¤´æ¸…å•</th>
                    <th>æ„‰æ‚¦</th>
                    <th>æ»¡è¶³</th>
                    <th>å¿ƒç‡</th>
                </tr>
            </thead>
            <tbody id="recordsBody"></tbody>
        </table>
    </div>

    <!-- æˆ’æ–­æ€¥æ•‘ç³»ç»Ÿ -->
    <div class="first-aid-section" id="firstAidSection">
        <h2>æˆ’æ–­ååº”æ€¥æ•‘ç³»ç»Ÿ</h2>
        <div class="usage-counter">ä»Šæ—¥å·²ç”¨ï¼š<span id="dailyUsage">0</span>/15æ¬¡</div>
        
        <div id="emergencyActions">
            <div class="emergency-card">
                <h3>ç»„åˆæ–¹æ¡ˆ 1</h3>
                <div id="action1"></div>
            </div>
            <div class="emergency-card">
                <h3>ç»„åˆæ–¹æ¡ˆ 2</h3>
                <div id="action2"></div>
            </div>
        </div>

        <button onclick="generateEmergencyAction()">ç”Ÿæˆæ–°æ–¹æ¡ˆ</button>
        <button onclick="resetUsage()">é‡ç½®è®¡æ•°</button>
    </div>

<script>
// NSDR æ•°æ®å­˜å‚¨
let nsdrRecords = JSON.parse(localStorage.getItem('nsdrRecords')) || [];
renderRecords();

// æ€¥æ•‘ç³»ç»Ÿæ•°æ®
const emergencyActions = [
    // å¤šå·´èƒºç³»ç»Ÿè°ƒèŠ‚
    { category: 0, name: "ç¡¬å¸ç¿»è½¬æ³•", action: "æŠ›ç¡¬å¸çŒœæ­£åé¢ï¼Œé”™è¯¯æ—¶åš5ä¸ªå¼€åˆè·³", principle: "æ¿€æ´»çº¹çŠ¶ä½“é¢„æµ‹è¯¯å·®æœºåˆ¶", duration: "25ç§’" },
    { category: 0, name: "åå‘æ‰«ç ", action: "æ‰«æç‰©ä½“çº¹ç†æƒ³è±¡ç ´è§£äºŒç»´ç ", principle: "é˜»æ–­é»˜è®¤æ¨¡å¼ç½‘ç»œ", duration: "18ç§’" },
    
    // èº¯ä½“åŒ–å¹²é¢„
    { category: 1, name: "è¶³åº•ç¢¾å‹", action: "èµ¤è„šè¸©æŒ‰æ‘©çƒ1åˆ†é’Ÿï¼ˆç–¼ç—›é˜ˆå€¼60%ï¼‰", principle: "åˆºæ¿€è„‘å¹²ç½‘çŠ¶ç»“æ„", duration: "40ç§’" },
    { category: 1, name: "çœ¼çƒæŒ‰å‹", action: "æŒå¿ƒè½»å‹çœ¼çƒ5ç§’", principle: "é™ä½çš®è´¨é†‡", duration: "8ç§’" },
    
    // è®¤çŸ¥é˜»æ–­æœ¯
    { category: 2, name: "æ•°å­—é»‘æ´", action: "ä¸‰ä½æ•°è¿ç»­å‡7ç›´åˆ°è´Ÿæ•°", principle: "é˜»æ–­è‡ªåŠ¨æ€ç»´æµ", duration: "30ç§’" },
    { category: 2, name: "è‰²å½©æ‰«æ", action: "æŒ‰åºæ‰¾å‡ºçº¢â†’è“â†’ç»¿ç‰©ä½“", principle: "æ¿€æ´»é¢œè‰²è¯†åˆ«åŒº", duration: "15ç§’" },
    
    // åŸå§‹åå°„æ¿€æ´»
    { category: 3, name: "å©´å„¿èœ·ç¼©", action: "èƒå„¿å§¿åŠ¿æ·±å‘¼å¸3æ¬¡", principle: "æŠ‘åˆ¶äº¤æ„Ÿç¥ç»", duration: "25ç§’" },
    { category: 3, name: "æ•é£Ÿå‡è§†", action: "èšç„¦è§‚å¯Ÿå°ç‰©ä½“", principle: "æŠ‘åˆ¶æä»æ ¸", duration: "10ç§’" },
    
    // è·¨æ„Ÿå®˜å¹²æ‰°
    { category: 4, name: "å‘³è§‰è½°ç‚¸", action: "è·³è·³ç³–+æŸ æª¬ç‰‡åŒæ—¶å«æœ", principle: "è¶…è´Ÿè·ç¥ç»åˆºæ¿€", duration: "3ç§’" },
    { category: 4, name: "æ¸©å·®å¯¹å†²", action: "å·¦æ‰‹å†°/å³è„šçƒ­æ°´", principle: "çŸ›ç›¾ä¿¡å·ä¼ è¾“", duration: "7ç§’" },
    
    // è¿åŠ¨ä»£å¿
    { category: 5, name: "é‡åŠ›å¯¹æŠ—", action: "èƒŒé å¢™å¤ªç©ºæ¼«æ­¥", principle: "æ¿€æ´»å°è„‘ä»£å¿", duration: "45ç§’" },
    { category: 5, name: "æŒ‡å°–èŠ­è•¾", action: "å¿«é€Ÿè½»æ‹æŒ‡è…¹", principle: "åˆºæ¿€ä½“æ„Ÿçš®å±‚", duration: "15ç§’" },
    
    // è¶…å¿«é€Ÿæ–¹æ¡ˆ
    { category: 6, name: "é¢…éª¨æ•²å‡»", action: "å¿«é€Ÿè½»æ•²ç™¾ä¼šç©´", principle: "å½±å“é»˜è®¤æ¨¡å¼ç½‘ç»œ", duration: "3ç§’" },
    { category: 6, name: "ç³å­”éœ‡è¡", action: "å¿«é€Ÿçœ¨çœ¼+èˆŒå°–é¡¶é¢š", principle: "ç¥ç»è”åˆåå°„", duration: "2ç§’" }
];

let actionUsage = JSON.parse(localStorage.getItem('actionUsage')) || {};
let dailyUsage = getDailyUsage();

// æ ¸å¿ƒåŠŸèƒ½
function saveNSDR() {
    try {
        const record = {
            date: document.getElementById('date').value,
            duration: parseInt(document.getElementById('duration').value) || 0,
            distractions: parseInt(document.getElementById('distractions').value) || 0,
            thoughts: document.getElementById('thoughts').value,
            pleasure: parseInt(document.getElementById('pleasure').value),
            satisfaction: parseInt(document.getElementById('satisfaction').value),
            heartRate: parseInt(document.getElementById('heartRate').value) || 0
        };
        
        nsdrRecords.push(record);
        localStorage.setItem('nsdrRecords', JSON.stringify(nsdrRecords));
        renderRecords();
        alert('ä¿å­˜æˆåŠŸï¼âœ“');
    } catch (error) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
}

function generateEmergencyAction() {
    try {
        if(dailyUsage >= 15) {
            alert("âš ï¸ ä»Šæ—¥å·²è¾¾å®‰å…¨ä½¿ç”¨ä¸Šé™ï¼ˆ15æ¬¡ï¼‰");
            return;
        }
        
        // è·¨æ¨¡æ€ç»„åˆ
        const categories = new Set();
        while(categories.size < 2) {
            const randomCat = Math.floor(Math.random() * 7);
            categories.add(randomCat);
        }
        
        const actions = [];
        categories.forEach(cat => {
            const available = emergencyActions.filter(a => a.category === cat);
            actions.push(available[Math.floor(Math.random() * available.length)]);
        });

        // åº”ç”¨é˜ˆå€¼çªç ´
        actions.forEach(action => {
            const usage = actionUsage[action.name] || 0;
            if(usage > 7) {
                action.action += `ï¼ˆå‡çº§ç‰ˆï¼š${getUpgradedAction(action.name)})`;
            }
            actionUsage[action.name] = usage + 1;
        });

        localStorage.setItem('actionUsage', JSON.stringify(actionUsage));
        displayActions(actions);
        updateUsage();
        alert('ç”ŸæˆæˆåŠŸï¼ğŸ‰');
    } catch (error) {
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
    }
}

function getUpgradedAction(name) {
    const upgrades = {
        'è¶³åº•ç¢¾å‹': 'ç–¼ç—›é˜ˆå€¼æå‡è‡³70%',
        'æ¸©å·®å¯¹å†²': 'æ°´æ¸©å·®å¢åŠ 5â„ƒ',
        'çœ¼çƒæŒ‰å‹': 'æŒ‰å‹æ—¶é—´å»¶é•¿è‡³8ç§’',
        'é»˜è®¤': 'å¼ºåº¦æå‡20%'
    };
    return upgrades[name] || upgrades['é»˜è®¤'];
}

// ç•Œé¢æ›´æ–°
function renderRecords() {
    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = nsdrRecords.map(record => `
        <tr>
            <td>${record.date}</td>
            <td>${record.duration}åˆ†é’Ÿ</td>
            <td>${record.distractions}æ¬¡</td>
            <td>${record.thoughts}</td>
            <td>${record.pleasure}</td>
            <td>${record.satisfaction}</td>
            <td>${record.heartRate}</td>
        </tr>
    `).join('');
}

function displayActions(actions) {
    document.getElementById('action1').innerHTML = formatAction(actions[0]);
    document.getElementById('action2').innerHTML = formatAction(actions[1]);
}

function formatAction(action) {
    return `
        <strong>${action.name}</strong><br>
        ğŸ•’ ${action.duration}<br>
        âœ‹ ${action.action}<br>
        ğŸ”¬ ${action.principle}<br>
        ğŸ“Š ç´¯è®¡ä½¿ç”¨ï¼š${actionUsage[action.name] || 0}æ¬¡
    `;
}

// å·¥å…·å‡½æ•°
function exportCSV() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "æ—¥æœŸ,æ—¶é•¿,åˆ†å¿ƒæ¬¡æ•°,å¿µå¤´æ¸…å•,æ„‰æ‚¦,æ»¡è¶³,å¿ƒç‡\n"
        + nsdrRecords.map(r => 
            `${r.date},${r.duration},${r.distractions},"${r.thoughts}",${r.pleasure},${r.satisfaction},${r.heartRate}`
        ).join("\n");
    
    const link = document.createElement('a');
    link.href = encodeURI(csvContent);
    link.download = `nsdrè®°å½•_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

function getDailyUsage() {
    const today = new Date().toISOString().slice(0,10);
    return localStorage.getItem('dailyUsageDate') === today 
        ? parseInt(localStorage.getItem('dailyUsage')) || 0 
        : 0;
}

function updateUsage() {
    dailyUsage++;
    const today = new Date().toISOString().slice(0,10);
    localStorage.setItem('dailyUsage', dailyUsage);
    localStorage.setItem('dailyUsageDate', today);
    document.getElementById('dailyUsage').textContent = dailyUsage;
}

function resetUsage() {
    dailyUsage = 0;
    updateUsage();
}

// åˆå§‹åŒ–
document.getElementById('date').valueAsDate = new Date();
document.getElementById('dailyUsage').textContent = dailyUsage;

// äº‹ä»¶ç»‘å®š
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const tab = this.dataset.tab;
        document.getElementById('nsdrSection').style.display = tab === 'nsdr' ? 'block' : 'none';
        document.getElementById('firstAidSection').style.display = tab === 'firstAid' ? 'block' : 'none';
    });
});
</script>
</body>
</html>
